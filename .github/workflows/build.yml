name: Build Box64 (aarch64)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©æ—©ä¸Š6ç‚¹è‡ªåŠ¨æ£€æŸ¥æ›´æ–°æ„å»º

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

env:
  LAST_COMMIT_FILE: last_box64_commit.txt

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ”¹ æ£€å‡ºæºç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      # ğŸ”¹ å®‰è£…æ„å»ºä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc git patchelf jq curl unzip

      # ğŸ”¹ è·å– Box64 æœ€æ–°æäº¤
      - name: è·å– Box64 æœ€æ–°æäº¤ä¿¡æ¯
        id: get_latest
        run: |
          set -e
          LATEST_COMMIT=$(git ls-remote https://github.com/ptitSeb/box64 HEAD | awk '{print $1}')
          if [ -z "$LATEST_COMMIT" ]; then
            echo "âŒ è·å– Box64 æäº¤ä¿¡æ¯å¤±è´¥"
            exit 1
          fi
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          # è·å–æäº¤è¯¦æƒ…
          curl -s "https://api.github.com/repos/ptitSeb/box64/commits/$LATEST_COMMIT" -o commit.json
          COMMIT_DATE=$(jq -r '.commit.author.date' commit.json)
          COMMIT_AUTHOR=$(jq -r '.commit.author.name' commit.json)
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_ENV
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_ENV
          echo "âœ… æœ€æ–°æäº¤: $LATEST_COMMIT  ä½œè€…: $COMMIT_AUTHOR  æ—¶é—´: $COMMIT_DATE"

      # ğŸ”¹ è·å–ä¸Šæ¬¡æ„å»ºæäº¤
      - name: è·å–ä¸Šæ¬¡æ„å»ºæäº¤
        id: get_last
        run: |
          if [ -f "${{ env.LAST_COMMIT_FILE }}" ]; then
            LAST_COMMIT=$(cat "${{ env.LAST_COMMIT_FILE }}")
            echo "ä¸Šæ¬¡æ„å»ºæäº¤: $LAST_COMMIT"
          else
            LAST_COMMIT="none"
            echo "æœªæ‰¾åˆ°ä¸Šæ¬¡æ„å»ºè®°å½•"
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV

      # ğŸ”¹ æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "âœ… æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°æäº¤ï¼Œå‡†å¤‡æ„å»º..."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      # ğŸ”¹ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: |
          echo "âœ… æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
          exit 0

      # ğŸ”¹ å…‹éš† Box64 å¹¶æ„å»º
      - name: å…‹éš† Box64 å¹¶æ„å»º
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          git clone --depth=1 https://github.com/ptitSeb/box64
          cd box64
          mkdir build && cd build
          cmake .. \
            -DARM_DYNAREC=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DARM64=ON \
            -DNOLOADAD=ON \
            -DBAD_SIGN=ON \
            -DSAVE_MEM=ON \
            -DSD8G2=ON
          make -j$(nproc)
          echo "âœ… æ„å»ºå®Œæˆ"
          # ä¿®å¤åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ï¼ˆTermux glibcï¼‰
          patchelf --set-interpreter /data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1 box64 || true
          # æ‰“åŒ…
          SHORT_COMMIT="${LATEST_COMMIT:0:7}"
          TAR_FILE="termux-glibc-box64-${SHORT_COMMIT}.tar.gz"
          tar -czvf ../../$TAR_FILE box64
          echo "$LATEST_COMMIT" > ../../${{ env.LAST_COMMIT_FILE}}
          echo "TAR_FILE=$TAR_FILE" >> $GITHUB_ENV
          echo "VERSION=$SHORT_COMMIT" >> $GITHUB_ENV

      # ğŸ”¹ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: termux-glibc-box64-${{ env.VERSION }}
          path: ${{ env.TAR_FILE }}

      # ğŸ”¹ æäº¤ last commit æ–‡ä»¶åˆ°ä»“åº“
      - name: æ›´æ–° last commit æ–‡ä»¶åˆ°ä»“åº“
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git checkout main
          git add ${{ env.LAST_COMMIT_FILE }}
          git commit -m "Update last_box64_commit.txt to $LATEST_COMMIT" || echo "æ— å˜åŒ–"
          git push origin main || echo "æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰æƒé™"

      # ğŸ”¹ å‘å¸ƒ Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: box64-${{ env.VERSION }}
          name: Box64 ${{ env.VERSION }} (aarch64, Termux glibc)
          body: |
            âœ… **Box64 è‡ªåŠ¨æ„å»ºæˆåŠŸï¼**
            - æäº¤å“ˆå¸Œ: ${{ env.LATEST_COMMIT }}
            - ä½œè€…: ${{ env.commit_author }}
            - æäº¤æ—¶é—´: ${{ env.commit_date }}
            - ç‰ˆæœ¬å·: ${{ env.VERSION }}
          files: ${{ env.TAR_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
