name: Build Box64 (aarch64)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©æ—©ä¸Š6ç‚¹è‡ªåŠ¨æ£€æŸ¥æ›´æ–°æ„å»º

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ”¹ æ£€å‡º workflow ä»“åº“
      - name: æ£€å‡ºæºç 
        uses: actions/checkout@v4

      # ğŸ”¹ å®‰è£…æ„å»ºä¾èµ–
      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc git patchelf jq curl

      # ğŸ”¹ è·å– Box64 æœ€æ–°æäº¤ä¿¡æ¯
      - name: è·å– Box64 æœ€æ–°æäº¤ä¿¡æ¯
        id: get_latest
        run: |
          LATEST_COMMIT=$(git ls-remote https://github.com/ptitSeb/box64 HEAD | awk '{print $1}')
          echo "æœ€æ–°æäº¤: $LATEST_COMMIT"
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT

          # è·å–æäº¤è¯¦æƒ…
          curl -s "https://api.github.com/repos/ptitSeb/box64/commits/$LATEST_COMMIT" -o commit.json
          COMMIT_DATE=$(jq -r '.commit.author.date' commit.json)
          COMMIT_AUTHOR=$(jq -r '.commit.author.name' commit.json)
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "æœ€æ–°æäº¤æ—¶é—´: $COMMIT_DATE"
          echo "æäº¤ä½œè€…: $COMMIT_AUTHOR"

      # ğŸ’¾ æ™ºèƒ½æ£€æµ‹ + ä¸‹è½½ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•
      - name: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•
        id: check_artifact
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æµ‹æ˜¯å¦å­˜åœ¨ä¸Šæ¬¡æ„å»ºçš„æäº¤è®°å½•..."
          ARTIFACT_API="https://api.github.com/repos/${{ github.repository }}/actions/artifacts"
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$ARTIFACT_API")
          if echo "$RESPONSE" | grep -q '"name": "last-box64-commit"'; then
            echo "artifact_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°ä¸Šæ¬¡æ„å»ºçš„æäº¤è®°å½• artifactã€‚"
          else
            echo "artifact_exists=false" >> $GITHUB_OUTPUT
            echo "âšª æœªæ£€æµ‹åˆ°ä¸Šæ¬¡æ„å»ºè®°å½•ï¼ˆå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œï¼‰ã€‚"
          fi

      - name: ä¸‹è½½ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•
        if: steps.check_artifact.outputs.artifact_exists == 'true'
        uses: actions/download-artifact@v4
        with:
          name: last-box64-commit
          path: ./last_commit

      - name: åˆ›å»ºç©º last_commit ç›®å½•
        if: steps.check_artifact.outputs.artifact_exists == 'false'
        run: |
          mkdir -p ./last_commit
          echo "none" > ./last_commit/last_box64_commit.txt

      # ğŸ”¹ æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          LAST_COMMIT_FILE="./last_commit/last_box64_commit.txt"
          if [ -f "$LAST_COMMIT_FILE" ]; then
            LAST_COMMIT=$(cat "$LAST_COMMIT_FILE")
            echo "æ‰¾åˆ°ä¸Šæ¬¡æ„å»ºæäº¤: $LAST_COMMIT"
          else
            LAST_COMMIT="none"
            echo "é¦–æ¬¡è¿è¡Œæˆ–æœªæ‰¾åˆ°ä¸Šæ¬¡æ„å»ºè®°å½•"
          fi

          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "âœ… æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°æäº¤ï¼Œå‡†å¤‡æ„å»º..."
            echo "ä¸Šæ¬¡æäº¤: $LAST_COMMIT"
            echo "æœ€æ–°æäº¤: $LATEST_COMMIT"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      # ğŸ”¹ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: |
          echo "âœ… æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
          exit 0

      # ğŸ”¹ å…‹éš† Box64 å¹¶æ„å»º
      - name: å…‹éš† Box64 å¹¶æ„å»º
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          git clone --depth=1 https://github.com/ptitSeb/box64
          cd box64
          mkdir build && cd build

          cmake .. \
            -DARM_DYNAREC=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DARM64=ON \
            -DNOLOADAD=ON \
            -DBAD_SIGN=ON \
            -DSAVE_MEM=ON \
            -DSD8G2=ON

          make -j$(nproc)
          echo "âœ… æ„å»ºå®Œæˆ"

          # ä¿®å¤åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ï¼ˆTermux glibcï¼‰
          patchelf --set-interpreter /data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1 box64 || true

          # åˆ›å»ºç‰ˆæœ¬å·å’Œæ–‡ä»¶å
          SHORT_COMMIT="${LATEST_COMMIT:0:7}"
          TAR_FILE="termux-glibc-box64-${SHORT_COMMIT}.tar.gz"
          
          tar -czvf ../../$TAR_FILE box64
          echo "$LATEST_COMMIT" > ../../last_box64_commit.txt
          echo "VERSION=${SHORT_COMMIT}" >> $GITHUB_ENV
          echo "TAR_FILE=$TAR_FILE" >> $GITHUB_ENV

      # ğŸ”¹ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: termux-glibc-box64-${{ env.VERSION }}
          path: ${{ env.TAR_FILE }}

      # ğŸ”¹ ä¸Šä¼  last commit è®°å½•
      - name: ä¸Šä¼  last commit è®°å½•
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-box64-commit
          path: last_box64_commit.txt
          retention-days: 365

      # ğŸ”¹ å‘å¸ƒåˆ° GitHub Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: box64-${{ env.VERSION }}
          name: Box64 ${{ env.VERSION }} (aarch64, Termux glibc)
          body: |
            âœ… **Box64 è‡ªåŠ¨æ„å»ºæˆåŠŸï¼**
            
            **æ„å»ºä¿¡æ¯:**
            - æäº¤å“ˆå¸Œ: `${{ steps.get_latest.outputs.commit }}`
            - ä½œè€…: `${{ steps.get_latest.outputs.commit_author }}`
            - æäº¤æ—¶é—´: `${{ steps.get_latest.outputs.commit_date }}`
            - ç‰ˆæœ¬å·: `${{ env.VERSION }}`
            - æ„å»ºå¹³å°: Ubuntu 24.04 ARM64
            - æ„å»ºæ—¶é—´: ${{ fromJSON(format('"{0}"', github.run_started_at)) }}

            **ä½¿ç”¨æ–¹æ³•:**
            1. è§£å‹åèµ‹äºˆæ‰§è¡Œæƒé™: `chmod +x box64`
            2. ç¡®ä¿å·²å®‰è£… Termux glibc ç¯å¢ƒ
            3. è¿è¡Œ: `./box64 <x86_64ç¨‹åº>`
          files: ${{ env.TAR_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ”¹ è¾“å‡ºæ„å»ºç»“æœ
      - name: è¾“å‡ºæ„å»ºç»“æœ
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          echo "âœ… Box64 æ„å»ºå®Œæˆ"
          echo "ğŸ”– ç‰ˆæœ¬å·: $VERSION"
          echo "ğŸ§¾ æäº¤å®Œæ•´å“ˆå¸Œ: ${LATEST_COMMIT}"
          echo "ğŸ‘¤ ä½œè€…: ${{ steps.get_latest.outputs.commit_author }}"
          echo "ğŸ“… æäº¤æ—¶é—´: ${{ steps.get_latest.outputs.commit_date }}"
          echo "ğŸ“¦ æ‰“åŒ…æ–‡ä»¶: $TAR_FILE"
          ls -lh $TAR_FILE
