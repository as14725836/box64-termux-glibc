name: Build Box64 (aarch64)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©æ—©ä¸Š6ç‚¹è‡ªåŠ¨æ£€æŸ¥æ›´æ–°æ„å»º

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ”¹ æ£€å‡º workflow ä»“åº“
      - name: æ£€å‡ºæºç 
        uses: actions/checkout@v4

      # ğŸ”¹ å®‰è£…æ„å»ºä¾èµ–
      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc git patchelf

      # ğŸ”¹ è·å– Box64 æœ€æ–°æäº¤
      - name: è·å– Box64 æœ€æ–°æäº¤
        id: get_latest
        run: |
          LATEST_COMMIT=$(git ls-remote https://github.com/ptitSeb/box64 HEAD | awk '{print $1}')
          echo "æœ€æ–°æäº¤: $LATEST_COMMIT"
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV

      # ğŸ”¹ ä¸‹è½½ä¸Šæ¬¡æ„å»ºæäº¤è®°å½• artifact
      - name: ä¸‹è½½ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•
        id: download_last_commit
        uses: actions/download-artifact@v4
        with:
          name: last-box64-commit
          path: ./last_commit || true

      # ğŸ”¹ æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          LAST_COMMIT_FILE="./last_commit/last_box64_commit.txt"
          if [ -f "$LAST_COMMIT_FILE" ]; then
            LAST_COMMIT=$(cat "$LAST_COMMIT_FILE")
          else
            LAST_COMMIT="none"
          fi

          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "âœ… æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°æäº¤ï¼Œå‡†å¤‡æ„å»º..."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      # ğŸ”¹ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: exit 0

      # ğŸ”¹ å…‹éš† Box64 å¹¶æ„å»º
      - name: å…‹éš† Box64 å¹¶æ„å»º
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          git clone --depth=1 https://github.com/ptitSeb/box64
          cd box64
          mkdir build && cd build

          cmake .. \
            -DARM_DYNAREC=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DARM64=ON \
            -DNOLOADAD=ON \
            -DBAD_SIGN=ON \
            -DSAVE_MEM=ON \
            -DSD8G2=ON

          make -j$(nproc)
          echo "âœ… æ„å»ºå®Œæˆ"

          patchelf --set-interpreter /data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1 box64 || true

          TAR_FILE=../../termux-glibc-box64-${LATEST_COMMIT:0:7}.tar.gz
          tar -czvf $TAR_FILE box64

          # ä¿å­˜ last commit
          echo "$LATEST_COMMIT" > ../../last_box64_commit.txt
          echo "VERSION=${LATEST_COMMIT:0:7}" >> $GITHUB_ENV
          echo "TAR_FILE=$TAR_FILE" >> $GITHUB_ENV

      # ğŸ”¹ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: termux-glibc-box64-${{ env.VERSION }}
          path: ${{ env.TAR_FILE }}

      # ğŸ”¹ ä¸Šä¼  last commit è®°å½•
      - name: ä¸Šä¼  last commit è®°å½•
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-box64-commit
          path: last_box64_commit.txt

      # ğŸ”¹ å‘å¸ƒåˆ° GitHub Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name || env.VERSION }}
          name: Box64 (aarch64, Termux glibc)
          body: |
            âœ… Box64 è‡ªåŠ¨æ„å»ºæˆåŠŸ
            - Commit: `${{ env.LATEST_COMMIT }}`
            - æ„å»ºå¹³å°: Ubuntu 24.04 ARM64
          files: ${{ env.TAR_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ”¹ è¾“å‡ºæ„å»ºç»“æœ
      - name: è¾“å‡ºæ„å»ºç»“æœ
        run: |
          echo "âœ… Box64 æ„å»ºå®Œæˆ"
          echo "ğŸ”– ç‰ˆæœ¬å· (å‰7ä½ commit hash): $VERSION"
          echo "ğŸ“ æäº¤å®Œæ•´ hash: ${LATEST_COMMIT}"
          echo "ğŸ“¦ æ‰“åŒ…æ–‡ä»¶ä¿¡æ¯:"
          ls -lh $TAR_FILE || true

      # ğŸ”¹ åœ¨ PR æˆ– Commit ä¸‹å‘å¸ƒæ„å»ºä¿¡æ¯
      - name: åœ¨ PR æˆ– Commit ä¸‹å‘å¸ƒæ„å»ºä¿¡æ¯
        if: steps.check_build.outputs.skip_build == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number || github.run_number }}
          body: |
            âœ… Box64 æ„å»ºå®Œæˆ
            ğŸ”– ç‰ˆæœ¬å· (å‰7ä½ commit hash): ${{ env.VERSION }}
            ğŸ“ æäº¤å®Œæ•´ hash: ${{ env.LATEST_COMMIT }}
            ğŸ“¦ æ‰“åŒ…æ–‡ä»¶: ${{ env.TAR_FILE }}
